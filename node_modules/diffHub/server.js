var http=require("http");	
var express=require("express");
var app=express();
var fs=require("fs");
var url=require("url");
var Client=require("mysql").Client;
var sqlClient=new Client();
sqlClient.query("USE diffHub",function(error,results){
	if(error)
	{
		console.log("Error in connecting to database "+error.message);
		return;
	}
	console.log("Successfully connected to database");
});
function idGenerate()
{
    var unique;                                                                                                                        
    do                                                                                                                                          
    {
	var keys="abcdefghijklmnopqrstuvwxyz123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ";  
	size=1+Math.floor(Math.random()*10);
	var workId="";
	for(i=0;i<size;i++)
	{                                                                             
	    var num=Math.floor(Math.random()*keys.length);                                              
	    workId+=keys.substring(num,num+1);                                                         
	}            
	sqlClient.query("SELECT * FROM workspacelist WHERE workspaceid=?",[workId],function(error,results){   
	    if(error)                                                   
	    {                                               
		console.log("Error in SELECT query inside workGenerator "+error.message);
		return;                                                                                                           
	    }                                                                                                    
	    if(results.length==0)                                                                      
		unique=0;                                                                                         
	    else                            
		unique=1;                                                                         
	});                                                             
    }                                                       
    while(unique==1);                                                                   
    return workId;                                                                                                                          
}
app.get('/',function(req,res){
	if(req.query['uname']!=undefined && req.query['pass']!=undefined)
	{
		var workId="0";
		var uname=req.query['uname'];
		var pass=req.query['pass'];
		sqlClient.query("SELECT * FROM userdetails WHERE username=? AND password=md5(?)",[uname,pass],function(error,results){
			if(error)
			{
				console.log("Error in SELECT query for checking logged in "+error.message);
				return;
			}
			if(results.length)
				workId=idGenerate();
			res.send(workId);
		});
	}
});
app.listen(8888);
console.log("Server running");