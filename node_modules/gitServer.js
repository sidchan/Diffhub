var http=require("http");
var fs=require("fs");
var url=require("url");
var Client=require("mysql").Client;
var sqlClient=new Client();
var root=fs.readFileSync('./root.html');
var newEditor=fs.readFileSync('./newEditor.html');
var existEditor=fs.readFileSync('./existEditor.html');
var mainJs=fs.readFileSync('./main.js');
var diffMatchPatchJs=fs.readFileSync('./diff_match_patch.js');
sqlClient.user="root";
sqlClient.password="";
sqlClient.query("USE githackers",function(error,results){
    if(error){
        console.log("error in connecting to the database...."+error.message);
        return;
    }
    console.log("Connected to database.....");
});
var server=http.createServer(function(request,response){
	console.log(request.query["id"]);
	if(request.url!='/favicon.ico')
	{
		if(request.url=='/main.js')
		{
			response.writeHead(200, {"Content-Type": "application/javascript"});
			response.write(mainJs);
			response.end();
		}
		else if(request.url=='/diff_match_patch.js')
		{
			response.writeHead(200, {"Content-Type": "application/javascript"});
			response.write(diffMatchPatchJs);
			response.end();
		}
		else if(request.url=='/')
		{	
			response.writeHead(200, {"Content-Type": "text/html"});
			response.write(root);
			response.end();
		}
		else
		{
			sqlClient.query("SELECT * FROM editorlist WHERE editorId=?",[request.url],function(error,results){
				if(error)
				{
					console.log("Error in checking if the url exists...."+error.message);
					return;
				}	
				if(results.length==0)
				{
					console.log("Create a new Editor for this guy...");
					sqlClient.query("INSERT INTO editorlist SET editorId=?",[request.url],function(error,results){
						if(error)
						{
							console.log("Error in inserting a new editor..."+error.message);
							return;
						}
						console.log("Created the editor..."+request.url);
						response.writeHead(200, {"Content-Type": "text/html"});
						response.write(newEditor);
						response.end();
					});
				}
				else
				{
					console.log("Open the editor..."+request.url);
					response.writeHead(200, {"Content-Type": "text/html"});
					response.write(existEditor);
					response.end();
				}
			});
		}
	}	
});
server.listen(8888);
console.log("Node server is running");
var nowjs = require("now");
var everyone = nowjs.initialize(server);
everyone.now.sendDiffs=function(receivedDiffs)
{
	everyone.now.sendDiffsResponse(receivedDiffs);
}